{% extends 'main/index.html' %}
{% load dict_extras %}

{% block title %}<title>Schedule</title>{% endblock title %}

{% block main %}
<div class="p-6">

  <!-- Page Header -->
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Class Timetable Scheduler</h1>
  </div>

  <!-- Timetable Form -->
  <form method="POST" class="space-y-6 bg-white p-6 rounded-xl shadow-lg">
    {% csrf_token %}
    
    <!-- Batch -->
    {% comment %} <div>
      <label class="block text-gray-700 font-semibold mb-2">Batch (Select one)</label>
      <select name="batch" class="w-full p-2 border rounded-lg">
        {% for b in batches %}
          <option value="{{ b.id }}">{{ b.batch_name }} ({{ b.course }} - Year {{ b.year }})</option>
        {% endfor %}
      </select>
    </div> {% endcomment %}
   <div>
  <label class="block text-gray-700 font-semibold mb-2">Batch (Select one)</label>
  <select id="batch" class="w-full p-2 border rounded-lg">
    <option value="">-- Select Batch --</option>
    <option value="MCA">MCA</option>
    <option value="BCA">BCA</option>
    <option value="BBA">BBA</option>
  </select>
</div>

<div>
  <label class="block text-gray-700 font-semibold mb-2">Subjects (Select multiple)</label>
  <select id="subjects" multiple class="w-full p-2 border rounded-lg h-32">
    <!-- Subjects will load dynamically -->
  </select>
  <p class="text-sm text-gray-500 mt-1">
    Hold <kbd>Ctrl</kbd> (Windows) or <kbd>Cmd</kbd> (Mac) to select multiple.
  </p>
</div>
  <!-- Subject -->
    {% comment %} <div>
      <label class="block text-gray-700 font-semibold mb-2">Subjects (Select multiple)</label>
      <select name="subjects" multiple class="w-full p-2 border rounded-lg h-32">
        {% for s in subjects %}
          <option value="{{ s.subject_name }}">{{ s.subject_name }} ({{ s.subject_code }})</option>
        {% endfor %}
      </select>
      <p class="text-sm text-gray-500 mt-1">Hold <kbd>Ctrl</kbd> (Windows) or <kbd>Cmd</kbd> (Mac) to select multiple.</p>
    </div> {% endcomment %}

    <!-- Faculty -->
    <div>
      <label class="block text-gray-700 font-semibold mb-2">Faculties (Select multiple)</label>
      <select name="faculty" multiple class="w-full p-2 border rounded-lg h-32">
        {% for f in faculty %}
          <option value="{{ f.name }}">{{ f.name }} - {{ f.designation }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Classroom -->
    <div>
      <label class="block text-gray-700 font-semibold mb-2">Classrooms (Select multiple)</label>
      <select name="classrooms" multiple class="w-full p-2 border rounded-lg h-32">
        {% for c in classrooms %}
          <option value="{{ c.class_name }}">{{ c.class_name }} ({{ c.room_type }}, Cap: {{ c.capacity }})</option>
        {% endfor %}
      </select>
    </div>

    <!-- Day -->
    <div>
      <label class="block text-gray-700 font-semibold mb-2">Days (Select multiple)</label>
      <select name="days" multiple class="w-full p-2 border rounded-lg h-32">
        {% for d in days %}
          <option value="{{ d }}">{{ d }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Time Slot -->
    <div class="mb-4">
      <label for="timeslot" class="block font-medium text-gray-700">
        Time Slot (Select one)
      </label>
      <select id="timeslot" name="timeslot"
              class="w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
          {% for slot in timeslots %}
              <option value="{{ slot.id }}">{{ slot|timeslot }}</option>
          {% empty %}
              <option disabled>No time slots available</option>
          {% endfor %}
      </select>
    </div>
    

    <div align="center">
      <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
        Generate Timetable
      </button>
    </div>
  </form>

  <!-- Display Timetable -->
  {% if timetable_grid %}
<div class="mt-10">
  <h2 class="text-2xl font-bold mb-6 text-gray-800">Generated Timetable</h2>

  <div class="overflow-x-auto">
    <table class="min-w-full border border-gray-300 rounded-lg shadow-lg">
      <thead class="bg-blue-600 text-white">
        <tr>
          <th class="border px-4 py-2 text-left">Time</th>
          {% for day in days %}
            <th class="border px-4 py-2 text-center">{{ day }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody class="bg-white">
        {% for slot in time_slots %}
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="border px-4 py-2 font-semibold bg-gray-100">{{ slot }}</td>

            {% for day in days %}
              {% with entry=timetable_grid|get_item:slot|get_item:day %}
                <td class="border px-4 py-2 text-center align-top">
                  {% if entry %}
                  <div class="bg-gray-50 p-2 rounded shadow-sm hover:shadow-md transition">
                    <div class="font-bold text-blue-700">{{ entry.subject|default:"--" }}</div>
                    <div class="text-sm text-gray-600">{{ entry.faculty|default:"--" }}</div>
                    <div class="text-sm text-gray-500">{{ entry.room|default:"--" }}</div>
                  </div>
                  {% else %}
                    <div class="text-gray-300">--</div>
                  {% endif %}
                </td>
              {% endwith %}
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

{% if metrics %}
<div class="mt-6 p-6 bg-gray-50 border border-gray-200 rounded-lg shadow-sm">
  <h3 class="text-xl font-semibold mb-4 text-gray-700">Timetable Metrics</h3>

  {% if metrics.errors %}
    <div class="mb-4 p-3 bg-red-100 text-red-700 rounded">
      <p class="font-semibold mb-1">Errors:</p>
      <ul class="list-disc list-inside">
        {% for error in metrics.errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <div class="grid grid-cols-3 gap-4 text-gray-700">
    <div class="bg-white p-3 rounded shadow text-center">
      <p class="font-semibold">Faculty Balance</p>
      <p class="text-blue-600 text-lg">{{ metrics.faculty_balance|floatformat:2 }}%</p>
    </div>
    <div class="bg-white p-3 rounded shadow text-center">
      <p class="font-semibold">Room Utilization</p>
      <p class="text-green-600 text-lg">{{ metrics.room_utilization|floatformat:2 }}%</p>
    </div>
    <div class="bg-white p-3 rounded shadow text-center">
      <p class="font-semibold">Learning Outcome</p>
      <p class="text-purple-600 text-lg">{{ metrics.learning_outcome|floatformat:2 }}%</p>
    </div>

      {% if timetable_grid %}
    <div class="mt-4">
      <a href="{% url 'export_timetable_csv' %}" 
        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
        Export Timetable as CSV
      </a>
    </div>
    {% endif %}

    <form method="POST">
      {% csrf_token %}
    <div align="center">
      <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
        Regenerate Timetable
      </button>
    </div>
  </form>

   {% if timetable_grid %}
  <div class="mt-4">
  <form method="POST" action="{% url 'publish_timetable' %}">
    {% csrf_token %}
    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
      Publish
    </button>
  </form>
</div>


    {% endif %}

  </div>
</div>
{% endif %}

<script>
  // Subjects based on course
  const courseSubjects = {
    MCA: ["DS", "Networking", "AI", "ML"],
    BCA: ["JAVA", "C", "HTML", "Python"],
    BBA: ["Economics", "Accounting", "Marketing", "Management"]
  };

  const batchSelect = document.getElementById("batch");
  const subjectsSelect = document.getElementById("subjects");

  batchSelect.addEventListener("change", function () {
    const selectedBatch = this.value;

    // Clear existing subjects
    subjectsSelect.innerHTML = "";

    if (selectedBatch && courseSubjects[selectedBatch]) {
      courseSubjects[selectedBatch].forEach(subject => {
        const option = document.createElement("option");
        option.value = subject;
        option.textContent = subject;
        subjectsSelect.appendChild(option);
      });
    }
  });
</script>
<script>
document.getElementById("publishBtn").addEventListener("click", function() {
    // Prepare timetable data
    let timetable = [];

    {% for slot in time_slots %}
      {% for day in days %}
        {% with entry=timetable_grid|get_item:slot|get_item:day %}
          {% if entry %}
            timetable.push({
                "day": "{{ day }}",
                "time": "{{ slot }}",
                "subject": "{{ entry.subject }}",
                "faculty": "{{ entry.faculty }}",
                "classroom": "{{ entry.room }}"
            });
          {% endif %}
        {% endwith %}
      {% endfor %}
    {% endfor %}

    fetch("{% url 'publish_timetable' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({timetable: timetable})
    })
    .then(resp => resp.json())
    .then(data => {
        if(data.success){
            alert("Timetable published successfully!");
        } else {
            alert("Error: " + (data.error || "Unknown error"));
        }
    })
    .catch(err => console.error(err));
});

  // Subjects based on course
  const courseSubjects = {
    MCA: ["DS", "Networking", "AI", "ML"],
    BCA: ["JAVA", "C", "HTML", "Python"],
    BBA: ["Economics", "Accounting", "Marketing", "Management"]
  };

  const batchSelect = document.getElementById("batch");
  const subjectsSelect = document.getElementById("subjects");

  batchSelect.addEventListener("change", function () {
    const selectedBatch = this.value;

    // Clear existing subjects
    subjectsSelect.innerHTML = "";

    if (selectedBatch && courseSubjects[selectedBatch]) {
      courseSubjects[selectedBatch].forEach(subject => {
        const option = document.createElement("option");
        option.value = subject;
        option.textContent = subject;
        subjectsSelect.appendChild(option);
      });
    }
  });

</script>


</div>
{% endblock main %}
